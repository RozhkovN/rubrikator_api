"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∂–∞–ª–æ–±.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python scripts/predict.py                    # –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
    python scripts/predict.py "–¢–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã"     # –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from src.model import ComplaintClassifier


def print_prediction(result: dict):
    """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è"""
    print("\n" + "=" * 80)
    print("üìÑ –¢–ï–ö–°–¢ –ñ–ê–õ–û–ë–´:")
    print("-" * 80)
    print(result['text'])
    print("\n" + "=" * 80)
    print("üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–ò:")
    print("=" * 80)
    
    for i, pred in enumerate(result['predictions'], 1):
        print(f"\n{i}. {pred['rubric_name']}")
        if pred.get('short_name'):
            print(f"   [{pred['short_name']}]")
        print(f"   –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {pred['confidence']:.2%}")
        if pred.get('semantic_score') is not None:
            print(f"   –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞: {pred['semantic_score']:.2%}")
        if pred.get('keyword_score') is not None:
            print(f"   –û—Ü–µ–Ω–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: {pred['keyword_score']:.2%}")
    
    print("\n" + "=" * 80)
    print(f"‚úÖ –õ–£–ß–®–ï–ï –°–û–í–ü–ê–î–ï–ù–ò–ï: {result['best_match']['rubric_name']}")
    print(f"   –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result['best_match']['confidence']:.2%}")
    print("=" * 80 + "\n")


def test_examples():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö –∂–∞–ª–æ–±"""
    test_cases = [
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ë–∞–Ω–∫ –°–±–µ—Ä–±–∞–Ω–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –º–æ—é –∫–∞—Ä—Ç—É –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω. –ù–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–∏–º –¥–µ–Ω—å–≥–∞–º —É–∂–µ –Ω–µ–¥–µ–ª—é. –¢—Ä–µ–±—É—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É!",
        
        "–ü—Ä–æ—à—É —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –≤–æ–ø—Ä–æ—Å—É –¥–µ–π—Å—Ç–≤–∏–π –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—Å–∫–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞. –ú–Ω–µ –∑–≤–æ–Ω—è—Ç –ø–æ 30 —Ä–∞–∑ –≤ –¥–µ–Ω—å, —É–≥—Ä–æ–∂–∞—é—Ç, –∑–≤–æ–Ω—è—Ç —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º. –î–æ–ª–≥ –ø–æ –º–∏–∫—Ä–æ—Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω –Ω–∞ –º–µ—Å—è—Ü, –Ω–æ —Ç–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã!",
        
        "–û–±—Ä–∞—â–∞—é—Å—å –∫ –≤–∞–º –∫–∞–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –ü–µ—Ç—Ä–æ–≤–∞ –ò.–ò. –ü—Ä–æ—à—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –ø–æ —Å—á–µ—Ç–∞–º –¥–æ–ª–∂–Ω–∏–∫–∞ —Å–æ–≥–ª–∞—Å–Ω–æ 115-–§–ó –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.",
        
        "–ú–Ω–µ –ø–æ–∑–≤–æ–Ω–∏–ª —á–µ–ª–æ–≤–µ–∫, –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–≤—à–∏–π—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –†–æ—Å—Ñ–∏–Ω–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞. –°–∫–∞–∑–∞–ª, —á—Ç–æ –º–æ–π —Å—á–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ—Ä—Ä–æ—Ä–∏–∑–º–∞ –∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—á–µ—Ç. –ü—Ä–æ—à—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —ç—Ç–æ –ª–∏—Ü–æ —É –≤–∞—Å.",
        
        "–°–ª—É—á–∞–π–Ω–æ –ø–µ—Ä–µ–≤–µ–ª 50000 —Ä—É–±–ª–µ–π –Ω–µ —Ç–æ–º—É —á–µ–ª–æ–≤–µ–∫—É —á–µ—Ä–µ–∑ –°–ë–ü. –ü–µ—Ä–µ–ø—É—Ç–∞–ª –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ. –ü–æ–ª—É—á–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–µ–Ω—å–≥–∏. –ü–æ–º–æ–≥–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞!",
        
        "–û–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –Ω–∞ –º–µ–Ω—è –æ—Ñ–æ—Ä–º–ª–µ–Ω –∫—Ä–µ–¥–∏—Ç –≤ –±–∞–Ω–∫–µ –í–¢–ë. –Ø —ç—Ç–æ—Ç –∫—Ä–µ–¥–∏—Ç –Ω–µ –±—Ä–∞–ª, –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–ª. –ü–æ–¥–æ–∑—Ä–µ–≤–∞—é –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ. –ü—Ä–æ—à—É –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–µ–¥–∏—Ç –∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É.",
    ]
    
    print("\n" + "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–õ–ê–°–°–ò–§–ò–ö–ê–¢–û–†–ê –ù–ê –ü–†–ò–ú–ï–†–ê–•")
    print("=" * 80)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    classifier = ComplaintClassifier()
    classifier.load("models/classifier.pkl")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–∏–º–µ—Ä
    for i, text in enumerate(test_cases, 1):
        print(f"\n\n{'='*80}")
        print(f"–ü–†–ò–ú–ï–† #{i}")
        print(f"{'='*80}")
        
        result = classifier.predict(text, top_k=3)
        print_prediction(result)


def interactive_mode():
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("\n" + "üí¨ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –†–ï–ñ–ò–ú")
    print("=" * 80)
    print("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã (–∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞)")
    print("=" * 80 + "\n")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    classifier = ComplaintClassifier()
    classifier.load("models/classifier.pkl")
    
    while True:
        print("\nüìù –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã:")
        text = input("> ").strip()
        
        if text.lower() in ['q', 'quit', 'exit', '–≤—ã—Ö–æ–¥']:
            print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            break
        
        if not text:
            print("‚ö†Ô∏è  –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã")
            continue
        
        result = classifier.predict(text, top_k=3)
        print_prediction(result)


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    if len(sys.argv) > 1:
        # –†–µ–∂–∏–º —Å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º - –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        text = " ".join(sys.argv[1:])
        
        classifier = ComplaintClassifier()
        classifier.load("models/classifier.pkl")
        
        result = classifier.predict(text, top_k=3)
        print_prediction(result)
    else:
        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        print("\n" + "ü§ñ –ö–õ–ê–°–°–ò–§–ò–ö–ê–¢–û–† –ñ–ê–õ–û–ë")
        print("=" * 80)
        print("\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:")
        print("  1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö")
        print("  2. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º (–≤–≤–æ–¥ —Å–≤–æ–µ–≥–æ —Ç–µ–∫—Å—Ç–∞)")
        print("  q. –í—ã—Ö–æ–¥")
        print("\n" + "=" * 80)
        
        choice = input("\n–í–∞—à –≤—ã–±–æ—Ä: ").strip()
        
        if choice == '1':
            test_examples()
        elif choice == '2':
            interactive_mode()
        elif choice.lower() in ['q', 'quit', 'exit', '–≤—ã—Ö–æ–¥']:
            print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
        else:
            print("\n‚ö†Ô∏è  –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä")


if __name__ == "__main__":
    main()
